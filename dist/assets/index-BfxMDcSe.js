import{c as g,a as f,b as S}from"./vendor-CjoviiFH.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();class I{constructor(t={}){this.deferredPrompt=null,this.showInstallButton=!1,this.showInstallButton=t.showInstallButton||!1,this.init()}init(){window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),this.deferredPrompt=t,this.showInstallButton?this.createInstallButton():console.log("📱 PWA can be installed (install button disabled)")}),window.addEventListener("appinstalled",()=>{console.log("PWA was installed"),this.hideInstallButton()}),this.registerServiceWorker(),this.handleConnectionChange()}async registerServiceWorker(){if("serviceWorker"in navigator)try{(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&console.log("[PWA] Development mode - Service Worker registration limited");const e=await navigator.serviceWorker.register("/sw.js");console.log("ServiceWorker registered successfully"),e.addEventListener("updatefound",()=>{const i=e.installing;i&&i.addEventListener("statechange",()=>{i.state==="installed"&&navigator.serviceWorker.controller&&this.showUpdateAvailable()})})}catch(t){console.log("ServiceWorker registration failed:",t)}}createInstallButton(){if(document.querySelector(".install-button"))return;const t=document.createElement("button");t.textContent="Instalar App",t.className="btn-primary install-button",t.style.cssText=`
      margin-left: 10px;
      font-size: 14px;
      padding: 6px 12px;
    `,t.addEventListener("click",()=>this.installPWA());const e=document.querySelector(".top-menu--container");e&&e.appendChild(t)}hideInstallButton(){const t=document.querySelector(".install-button");t&&t.remove()}async installPWA(){if(this.deferredPrompt){this.deferredPrompt.prompt();const{outcome:t}=await this.deferredPrompt.userChoice;console.log(`User response to the install prompt: ${t}`),this.deferredPrompt=null,this.hideInstallButton()}}showUpdateAvailable(){if(document.querySelector(".update-banner"))return;const t=document.createElement("div");t.className="update-banner",t.innerHTML=`
      <div style="background: #2c6ecb; color: white; padding: 10px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 10000;">
        Nueva versión disponible 
        <button onclick="this.parentElement.parentElement.remove(); location.reload();" 
                style="margin-left: 10px; padding: 5px 10px; background: white; color: #2c6ecb; border: none; border-radius: 4px; cursor: pointer;">
          Actualizar
        </button>
        <button onclick="this.parentElement.parentElement.remove();" 
                style="margin-left: 5px; padding: 5px 10px; background: transparent; color: white; border: 1px solid white; border-radius: 4px; cursor: pointer;">
          Después
        </button>
      </div>
    `,document.body.insertBefore(t,document.body.firstChild)}static isOnline(){return navigator.onLine}handleConnectionChange(){window.addEventListener("online",()=>{console.log("Back online"),document.body.classList.remove("offline"),this.showConnectionStatus("Conexión restaurada","success")}),window.addEventListener("offline",()=>{console.log("Gone offline"),document.body.classList.add("offline"),this.showConnectionStatus("Sin conexión - Modo offline","warning")})}showConnectionStatus(t,e){const i=document.querySelector(".connection-notification");i&&i.remove();const o=document.createElement("div");o.className="connection-notification",o.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: ${e==="success"?"#008060":"#d82c0d"};
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    `,o.textContent=t;const n=document.createElement("style");n.textContent=`
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `,document.head.appendChild(n),document.body.appendChild(o),setTimeout(()=>{o.remove()},3e3)}enableInstallButton(){this.showInstallButton=!0,this.deferredPrompt&&this.createInstallButton()}disableInstallButton(){this.showInstallButton=!1,this.hideInstallButton()}static async requestNotificationPermission(){return"Notification"in window?await Notification.requestPermission()==="granted":!1}static showNotification(t,e){"Notification"in window&&Notification.permission==="granted"&&new Notification(t,{icon:"/assets/icons/icon-192x192.png",badge:"/assets/icons/icon-192x192.png",...e})}static isInstalled(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0}static getNetworkInfo(){return navigator.connection||navigator.mozConnection||navigator.webkitConnection}}class v{constructor(t,e,i,o,n){this.id=t,this.img=e,this.nombre=i,this.dimensiones=o,this.precio=n}static fromJSON(t){return new v(t.id,t.img,t.nombre,t.dimensiones,t.precio)}toJSON(){return{id:this.id,img:this.img,nombre:this.nombre,dimensiones:this.dimensiones,precio:this.precio}}isValid(){return this.id>0&&this.nombre.trim().length>0&&this.precio>0}}class l{static saveProducts(t){try{localStorage.setItem(this.MUEBLES_KEY,JSON.stringify(t))}catch(e){console.error("Error saving products to localStorage:",e)}}static loadProducts(){try{const t=localStorage.getItem(this.MUEBLES_KEY);return t?JSON.parse(t):null}catch(t){return console.error("Error loading products from localStorage:",t),null}}static saveCart(t){try{localStorage.setItem(this.CARRITO_KEY,JSON.stringify(t))}catch(e){console.error("Error saving cart to localStorage:",e)}}static loadCart(){try{const t=localStorage.getItem(this.CARRITO_KEY);return t?JSON.parse(t):[]}catch(t){return console.error("Error loading cart from localStorage:",t),[]}}}l.MUEBLES_KEY="muebles_key";l.CARRITO_KEY="carrito_key";const P=[{id:1,img:"divan-nordico.jpg",nombre:"Diván nórdico",dimensiones:"100 x 50 x 45 cm",precio:79.99},{id:2,img:"estanteria-flotante.jpg",nombre:"Estantería flotante",dimensiones:"80 x 30 x 180 cm",precio:149.99},{id:3,img:"mesa-centro.jpg",nombre:"Mesa de centro",dimensiones:"160 x 90 x 75 cm",precio:249.99},{id:4,img:"silla-exterior.jpg",nombre:"Silla de exterior",dimensiones:"45 x 50 x 90 cm",precio:49.99},{id:5,img:"sofa-moderno.jpg",nombre:"Sofá moderno",dimensiones:"220 x 90 x 85 cm",precio:399.99},{id:6,img:"lampara-pie.jpg",nombre:"Lámpara de pie",dimensiones:"150 x 200 x 40 cm",precio:299.99}];class m{async getAllProducts(){return new Promise(t=>{const e=l.loadProducts();if(e)console.log("Cargando productos desde LocalStorage"),t(e);else{console.log("No hay productos en LocalStorage, cargando datos iniciales");const o=P.map(v.fromJSON).map(n=>n.toJSON());l.saveProducts(o),t(o)}})}async getProductById(t){return(await this.getAllProducts()).find(i=>i.id===t)||null}async saveProducts(t){return new Promise(e=>{l.saveProducts(t),e()})}}const k={items:[],loading:!1,error:null},p=g("products/fetchProducts",async()=>await new m().getAllProducts()),C=g("products/addProduct",async r=>{const t=new m,e=await t.getAllProducts(),i=Math.max(...e.map(s=>s.id),0)+1,o={...r,id:i},n=[...e,o];return await t.saveProducts(n),o}),x=g("products/updateProduct",async r=>{const t=new m,i=(await t.getAllProducts()).map(o=>o.id===r.id?r:o);return await t.saveProducts(i),r}),A=g("products/deleteProduct",async r=>{const t=new m,i=(await t.getAllProducts()).filter(o=>o.id!==r);return await t.saveProducts(i),r}),L=f({name:"products",initialState:k,reducers:{},extraReducers:r=>{r.addCase(p.pending,t=>{t.loading=!0,t.error=null}).addCase(p.fulfilled,(t,e)=>{t.loading=!1,t.items=e.payload}).addCase(p.rejected,(t,e)=>{t.loading=!1,t.error=e.error.message||"Failed to fetch products"}).addCase(C.fulfilled,(t,e)=>{t.items.push(e.payload)}).addCase(x.fulfilled,(t,e)=>{const i=t.items.findIndex(o=>o.id===e.payload.id);i!==-1&&(t.items[i]=e.payload)}).addCase(A.fulfilled,(t,e)=>{t.items=t.items.filter(i=>i.id!==e.payload)})}}),M=L.reducer,B={items:l.loadCart(),totalPrice:0},b=f({name:"cart",initialState:B,reducers:{addToCart:(r,t)=>{if(!r.items.find(i=>i.id===t.payload.id)){const i={...t.payload,cantidad:1};r.items.push(i),l.saveCart(r.items)}r.totalPrice=r.items.reduce((i,o)=>i+o.precio*o.cantidad,0)},removeFromCart:(r,t)=>{r.items=r.items.filter(e=>e.id!==t.payload),l.saveCart(r.items),r.totalPrice=r.items.reduce((e,i)=>e+i.precio*i.cantidad,0)},updateQuantity:(r,t)=>{const e=r.items.find(i=>i.id===t.payload.id);e&&(e.cantidad=t.payload.cantidad,l.saveCart(r.items),r.totalPrice=r.items.reduce((i,o)=>i+o.precio*o.cantidad,0))},clearCart:r=>{r.items=[],r.totalPrice=0,l.saveCart([])}}}),{addToCart:X,removeFromCart:Q,updateQuantity:Z,clearCart:tt}=b.actions,D=b.reducer,T={user:null,isAuthenticated:!1,isLoading:!1},E=f({name:"auth",initialState:T,reducers:{loginStart:r=>{r.isLoading=!0},loginSuccess:(r,t)=>{r.user=t.payload,r.isAuthenticated=!0,r.isLoading=!1},loginFailure:r=>{r.user=null,r.isAuthenticated=!1,r.isLoading=!1},logout:r=>{r.user=null,r.isAuthenticated=!1,r.isLoading=!1},initializeAuth:(r,t)=>{t.payload?(r.user=t.payload,r.isAuthenticated=!0):(r.user=null,r.isAuthenticated=!1),r.isLoading=!1}}}),{loginStart:N,loginSuccess:O,loginFailure:w,logout:z,initializeAuth:F}=E.actions,$=E.reducer,d=S({reducer:{products:M,cart:D,auth:$},middleware:r=>r({serializableCheck:{ignoredActions:["persist/PERSIST","persist/REHYDRATE"]}})}),V=[{id:"1",username:"admin",password:"admin123",role:"admin",name:"Administrador"},{id:"2",username:"manager",password:"manager123",role:"manager",name:"Gerente"},{id:"3",username:"stock",password:"stock123",role:"manager",name:"Encargado de Stock"}],R=(r,t)=>V.find(e=>e.username===r&&e.password===t)||null;class u{static async login(t,e){if(await new Promise(o=>setTimeout(o,300)),!t.trim()||!e.trim())return{success:!1,error:"Nombre de usuario y contraseña son requeridos"};const i=R(t,e);return i?(this.saveUserSession(i),{success:!0,user:i}):{success:!1,error:"Credenciales inválidas"}}static logout(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.SESSION_EXPIRY_KEY)}static getCurrentUser(){try{const t=localStorage.getItem(this.STORAGE_KEY),e=localStorage.getItem(this.SESSION_EXPIRY_KEY);return!t||!e?null:Date.now()>parseInt(e)?(this.logout(),null):JSON.parse(t)}catch(t){return console.error("Error al obtener usuario de localStorage:",t),this.logout(),null}}static isAuthenticated(){return this.getCurrentUser()!==null}static saveUserSession(t){try{const e=Date.now()+this.SESSION_DURATION;localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),localStorage.setItem(this.SESSION_EXPIRY_KEY,e.toString())}catch(e){console.error("Error al guardar sesión en localStorage:",e)}}static extendSession(){const t=this.getCurrentUser();t&&this.saveUserSession(t)}}u.STORAGE_KEY="nordora_user_session";u.SESSION_EXPIRY_KEY="nordora_session_expiry";u.SESSION_DURATION=24*60*60*1e3;class c{static async initializeAuth(){const t=u.getCurrentUser();d.dispatch(F(t))}static async login(t,e){d.dispatch(N());try{const i=await u.login(t,e);return i.success&&i.user?(d.dispatch(O(i.user)),{success:!0}):(d.dispatch(w()),{success:!1,error:i.error})}catch{return d.dispatch(w()),{success:!1,error:"Error interno del servidor"}}}static logout(){u.logout(),d.dispatch(z())}static isAuthenticated(){return d.getState().auth.isAuthenticated}static getCurrentUser(){return d.getState().auth.user}static requireAuth(){return this.isAuthenticated()?!0:(window.location.href="/pages/login.html",!1)}static redirectIfAuthenticated(){this.isAuthenticated()&&(window.location.href="/")}static extendSession(){this.isAuthenticated()&&u.extendSession()}}class h{static renderLoginButton(){return`
      <a href="/pages/login.html" class="btn-primary icon-txt-btn">
        <span class="material-symbols-outlined">login</span>
        Login
      </a>
    `}static renderLogoutButton(){return`
      <button class="btn-logout icon-txt-btn" id="logout-btn">
        <span class="material-symbols-outlined">logout</span>
        Cerrar sesión
      </button>
    `}static renderStockButton(){return`
      <a href="/pages/gestion-stock.html" class="btn-primary icon-txt-btn">
        <span class="material-symbols-outlined">settings</span>
        Gestionar stock
      </a>
    `}static initializeNavigation(){this.updateNavigationButtons(),this.setupLogoutHandler()}static updateNavigationButtons(){const t=document.querySelector("#nav-auth-buttons");if(!t)return;const e=c.isAuthenticated(),i=c.getCurrentUser(),o=window.location.pathname;t.innerHTML="",e&&i?o.includes("gestion-stock.html")?t.innerHTML=`
          ${this.renderUserWelcome()}
          ${this.renderLogoutButton()}
          <a href="/" class="btn-primary icon-txt-btn">
            <span class="material-symbols-outlined">storefront</span>
            Volver a la tienda
          </a>
        `:t.innerHTML=`
          ${this.renderUserWelcome()}
          ${this.renderLogoutButton()}
          ${this.renderStockButton()}
        `:t.innerHTML=`
        ${this.renderLoginButton()}
      `}static setupLogoutHandler(){document.addEventListener("click",t=>{t.target.id==="logout-btn"&&(t.preventDefault(),this.handleLogout())})}static handleLogout(){confirm("¿Estás seguro de que quieres cerrar sesión?")&&(c.logout(),this.updateNavigationButtons(),window.location.pathname.includes("gestion-stock.html")&&(window.location.href="/"))}static renderUserWelcome(){const t=c.getCurrentUser();return t?`
        <span class="user-welcome">Bienvenido, ${t.name}</span>
      `:""}static initializeLoginPage(){this.setupLoginForm(),c.redirectIfAuthenticated()}static setupLoginForm(){const t=document.getElementById("login-form");t&&t.addEventListener("submit",async e=>{e.preventDefault(),await this.handleLogin(t)})}static async handleLogin(t){const e=new FormData(t),i=e.get("username"),o=e.get("password"),n=t.querySelector('button[type="submit"]'),s=document.getElementById("login-error");n.disabled=!0,n.textContent="Entrando...",s&&(s.textContent="",s.style.display="none");try{const a=await c.login(i,o);a.success?window.location.href="/":s&&(s.textContent=a.error||"Error al iniciar sesión",s.style.display="block")}catch{s&&(s.textContent="Error interno. Intenta de nuevo.",s.style.display="block")}finally{n.disabled=!1,n.textContent="Entrar"}}}class H{constructor(t){this.productView=null,this.productService=t}setView(t){this.productView=t,this.productView.bindAddToCartEvent(this.handleAddToCart.bind(this))}async initialize(){if(!this.productView){console.log("ProductView not initialized, skipping product loading");return}try{const t=await this.productService.getAllProducts();this.productView.render(t)}catch(t){console.error("Error initializing products:",t)}}handleAddToCart(t){const e=new CustomEvent("addToCart",{detail:{productId:t}});document.dispatchEvent(e)}}class _{constructor(t,e){this.cartView=null,this.cartModel=t,this.productService=e,this.loadCartFromStorage()}setView(t){this.cartView=t,this.cartView.bindRemoveItemEvent(this.handleRemoveFromCart.bind(this))}async initialize(){if(!this.cartView){console.log("CartView not initialized, skipping cart loading");return}this.updateView(),document.addEventListener("addToCart",this.handleAddToCartEvent.bind(this))}async handleAddToCartEvent(t){const e=t,{productId:i}=e.detail;await this.addToCart(i)}async addToCart(t){try{const e=await this.productService.getProductById(t);if(!e){console.error(`Product with ID ${t} not found`);return}this.cartModel.addItem(e)?(this.saveCartToStorage(),this.updateView(),console.log(`Producto ${e.nombre} añadido al carrito`)):alert("El producto ya está en el carrito")}catch(e){console.error("Error adding product to cart:",e)}}handleRemoveFromCart(t){this.cartModel.removeItem(t)&&(this.saveCartToStorage(),this.updateView(),console.log(`Producto con ID ${t} eliminado del carrito`))}updateView(){if(!this.cartView)return;const t=this.cartModel.getItems(),e=this.cartModel.getTotalPrice();this.cartView.render(t,e)}loadCartFromStorage(){const t=l.loadCart();this.cartModel.setItems(t)}saveCartToStorage(){const t=this.cartModel.getItems();l.saveCart(t)}}class q{constructor(){if(this.maskOverlay=null,this.modalTitle=null,this.productForm=null,this.previewImg=null,this.maskOverlayDelete=null,this.modalMessage=null,this.currentProductId=null,this.isEditMode=!1,this.isStockPage())try{this.initializeElements(),this.bindEvents(),console.log("ModalService initialized successfully")}catch(t){console.warn("ModalService initialization failed:",t),console.warn("Modal functionality will not be available")}else console.log("ModalService skipped - not on stock management page")}isStockPage(){return document.getElementById("maskOverlay")!==null}initializeElements(){if(this.maskOverlay=this.getElementById("maskOverlay"),this.modalTitle=this.getElementById("modalTitle"),this.productForm=this.getElementById("productoForm"),this.previewImg=this.getElementById("previewImg"),this.maskOverlayDelete=this.getElementById("maskOverlayDelete"),this.modalMessage=this.querySelector(".modal-message"),!this.maskOverlay||!this.modalTitle||!this.productForm||!this.maskOverlayDelete||!this.modalMessage||!this.previewImg)throw new Error("Required modal elements not found in DOM")}getElementById(t){return document.getElementById(t)}querySelector(t){return document.querySelector(t)}bindEvents(){if(!this.maskOverlay||!this.maskOverlayDelete)return;const t=this.getElementById("closeModal"),e=this.getElementById("cancelModal"),i=this.getElementById("formNuevoProductoSubmit");t&&t.addEventListener("click",()=>this.closeModal()),e&&e.addEventListener("click",()=>this.closeModal()),i&&i.addEventListener("click",a=>this.handleSubmit(a));const o=this.getElementById("closeModalDelete"),n=this.getElementById("cancelModalDelete");o&&o.addEventListener("click",()=>this.closeDeleteModal()),n&&n.addEventListener("click",()=>this.closeDeleteModal()),this.maskOverlay.addEventListener("click",a=>{a.target===this.maskOverlay&&this.closeModal()}),this.maskOverlayDelete.addEventListener("click",a=>{a.target===this.maskOverlayDelete&&this.closeDeleteModal()});const s=this.getElementById("imagen");s&&s.addEventListener("input",a=>this.updateImagePreview(a))}openAddModal(){if(!this.modalTitle||!this.maskOverlay){console.error("Modal elements not available");return}this.isEditMode=!1,this.currentProductId=null,this.modalTitle.textContent="Añadir producto al stock",this.clearForm(),this.showModal()}openEditModal(t){if(!this.modalTitle||!this.maskOverlay){console.error("Modal elements not available");return}this.isEditMode=!0,this.currentProductId=t.id,this.modalTitle.textContent="Editar producto",this.populateForm(t),this.showModal()}openDeleteModal(t,e){var o;if(!this.modalMessage||!this.maskOverlayDelete){console.error("Delete modal elements not available");return}this.modalMessage.innerHTML=`
      <strong>¿Estás seguro de que quieres eliminar este producto?</strong><br><br>
      <strong>Nombre:</strong> ${t.nombre}<br>
      <strong>Precio:</strong> ${t.precio.toFixed(2)}€<br><br>
      <em>Esta acción no se puede deshacer.</em>
    `;const i=this.getElementById("btnDeleteConfirm");if(i){const n=i.cloneNode(!0);(o=i.parentNode)==null||o.replaceChild(n,i),n.addEventListener("click",()=>{e(),this.closeDeleteModal()})}this.showDeleteModal()}populateForm(t){const e=this.getElementById("id-field"),i=this.getElementById("imagen"),o=this.getElementById("nombre"),n=this.getElementById("dimensiones"),s=this.getElementById("precio");e&&(e.value=t.id.toString()),i&&(i.value=t.img),o&&(o.value=t.nombre),n&&(n.value=t.dimensiones),s&&(s.value=t.precio.toString()),this.updateImagePreview()}clearForm(){if(!this.productForm)return;this.productForm.reset();const t=this.getElementById("imagen");t&&(t.value="default-img.jpg"),this.hideImagePreview()}setProductId(t){const e=this.getElementById("id-field");e&&(e.value=t.toString())}updateImagePreview(t){const e=this.getElementById("imagen");if(!e||!this.previewImg)return;const i=e.value.trim();i&&i!=="default-img.jpg"?(this.previewImg.src=`../assets/images/${i}`,this.previewImg.style.display="block",this.previewImg.onerror=()=>{this.previewImg&&(this.previewImg.src="../assets/images/default-img.jpg")}):this.hideImagePreview()}hideImagePreview(){this.previewImg&&(this.previewImg.style.display="none")}handleSubmit(t){if(t.preventDefault(),!this.validateForm())return;const e=this.getFormData(),i=this.isEditMode?"editProduct":"addProduct",o=new CustomEvent(i,{detail:{productData:e,productId:this.currentProductId}});document.dispatchEvent(o),this.closeModal()}validateForm(){const t=this.getElementById("imagen"),e=this.getElementById("nombre"),i=this.getElementById("dimensiones"),o=this.getElementById("precio");if(!t||!e||!i||!o)return alert("Error: No se pueden acceder a los campos del formulario"),!1;const n=t.value.trim(),s=e.value.trim(),a=i.value.trim(),y=parseFloat(o.value);return n?s?a?isNaN(y)||y<=0?(alert("Por favor, ingresa un precio válido mayor que 0"),!1):!0:(alert("Por favor, ingresa las dimensiones del producto"),!1):(alert("Por favor, ingresa el nombre del producto"),!1):(alert("Por favor, ingresa el nombre del archivo de imagen"),!1)}getFormData(){const t=this.getElementById("id-field"),e=this.getElementById("imagen"),i=this.getElementById("nombre"),o=this.getElementById("dimensiones"),n=this.getElementById("precio");return{id:t&&parseInt(t.value)||void 0,img:e?e.value.trim():"",nombre:i?i.value.trim():"",dimensiones:o?o.value.trim():"",precio:n?parseFloat(n.value):0}}showModal(){this.maskOverlay&&(this.maskOverlay.classList.add("active"),document.body.style.overflow="hidden")}closeModal(){this.maskOverlay&&(this.maskOverlay.classList.remove("active"),document.body.style.overflow="",this.clearForm())}showDeleteModal(){this.maskOverlayDelete&&(this.maskOverlayDelete.classList.add("active"),document.body.style.overflow="hidden")}closeDeleteModal(){this.maskOverlayDelete&&(this.maskOverlayDelete.classList.remove("active"),document.body.style.overflow="")}}class U{constructor(t){this.stockView=null,this.productService=t,this.modalService=new q,this.bindModalEvents()}setView(t){this.stockView=t,this.stockView.bindEditEvent(this.handleEditProduct.bind(this)),this.stockView.bindDeleteEvent(this.handleDeleteProduct.bind(this)),this.stockView.bindAddProductEvent(this.handleAddProduct.bind(this))}async initialize(){if(!this.stockView){console.log("StockView not initialized, skipping stock loading");return}try{this.stockView.showLoading();const t=await this.productService.getAllProducts();this.stockView.render(t),console.log(`Stock initialized with ${t.length} products`)}catch(t){console.error("Error initializing stock:",t)}}bindModalEvents(){document.addEventListener("addProduct",this.handleAddProductSubmit.bind(this)),document.addEventListener("editProduct",this.handleEditProductSubmit.bind(this))}handleAddProduct(){console.log("Add product button clicked"),this.getNextAvailableId().then(t=>{this.modalService.setProductId(t),this.modalService.openAddModal()})}handleEditProduct(t){console.log(`Edit product ${t}`),this.productService.getProductById(t).then(e=>{e?this.modalService.openEditModal(e):alert("Producto no encontrado")})}handleDeleteProduct(t){console.log(`Delete product ${t}`),this.productService.getProductById(t).then(e=>{e?this.modalService.openDeleteModal(e,()=>{this.deleteProduct(t)}):alert("Producto no encontrado")})}async handleAddProductSubmit(t){const e=t,{productData:i}=e.detail;try{const o=await this.productService.getAllProducts(),n={id:i.id||await this.getNextAvailableId(),img:i.img,nombre:i.nombre,dimensiones:i.dimensiones,precio:i.precio};o.push(n),await this.productService.saveProducts(o),await this.initialize(),this.stockView&&this.stockView.highlightProduct(n.id),console.log("Product added successfully:",n)}catch(o){console.error("Error adding product:",o),alert("Error al añadir el producto")}}async handleEditProductSubmit(t){const e=t,{productData:i}=e.detail;try{const o=await this.productService.getAllProducts(),n=o.findIndex(s=>s.id===i.id);if(n!==-1)o[n]={id:i.id,img:i.img,nombre:i.nombre,dimensiones:i.dimensiones,precio:i.precio},await this.productService.saveProducts(o),await this.initialize(),this.stockView&&this.stockView.highlightProduct(i.id),console.log("Product updated successfully:",i);else throw new Error("Product not found for update")}catch(o){console.error("Error updating product:",o),alert("Error al actualizar el producto")}}async deleteProduct(t){try{const i=(await this.productService.getAllProducts()).filter(o=>o.id!==t);await this.productService.saveProducts(i),await this.initialize(),console.log(`Product ${t} deleted successfully`)}catch(e){console.error("Error deleting product:",e),alert("Error al eliminar el producto")}}async getNextAvailableId(){try{const t=await this.productService.getAllProducts();return t.length===0?1:Math.max(...t.map(i=>i.id))+1}catch(t){return console.error("Error getting next ID:",t),1}}}class Y{constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Container with ID "${t}" not found`);this.container=e}render(t){if(!t||t.length===0){this.container.innerHTML='<p style="color:peru; text-align:center;">No hay productos disponibles</p>';return}this.container.innerHTML="",t.forEach(e=>{const i=this.createProductCard(e);this.container.appendChild(i)}),console.log(`Renderizados ${t.length} productos`)}createProductCard(t){const e=document.createElement("article");return e.className="product-card",e.innerHTML=`
      <figure class="product-card--image">
        <img src="../assets/images/${t.img}" alt="${t.nombre}">
      </figure>
      <div class="product-card--info--container">
        <h3 class="product-card--name">${t.nombre}</h3>
        <p class="product-card--description">Dimensiones: ${t.dimensiones}</p>
        <p class="product-card--price">${t.precio.toFixed(2)}€</p>
        <button class="product-card--add-btn btn-primary" data-id="${t.id}">
          <span class="material-symbols-outlined">shopping_cart</span> 
          Añadir al carrito
        </button>
      </div>
    `,e}bindAddToCartEvent(t){this.container.addEventListener("click",e=>{const o=e.target.closest(".product-card--add-btn");if(o){const n=parseInt(o.getAttribute("data-id")||"0");n>0&&t(n)}})}}class W{constructor(t,e){const i=document.getElementById(t),o=document.getElementById(e);if(!i||!o)throw new Error("Cart containers not found");this.container=i,this.totalContainer=o}render(t,e){this.renderItems(t),this.renderTotal(e)}renderItems(t){if(!t||t.length===0){this.container.innerHTML='<p style="color:peru;">No hay productos en el carrito</p>';return}this.container.innerHTML="",t.forEach(e=>{const i=this.createCartItem(e);this.container.appendChild(i)}),console.log(`Renderizados ${t.length} items en el carrito`)}createCartItem(t){const e=document.createElement("article");return e.className="cart-list--list-item",e.innerHTML=`
      <div class="list-item--info">
        <div class="list-item--info--name">${t.nombre}</div>
        <div class="list-item--info--description">Cantidad: ${t.cantidad}</div>
        <div class="list-item--info--price">${t.precio.toFixed(2)}€</div>
      </div>
      <div class="list-item--action">
        <button class="btn-ghost btn-square-32px btn-remove" data-id="${t.id}">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    `,e}renderTotal(t){this.totalContainer.innerHTML=`${t.toFixed(2)}€`}bindRemoveItemEvent(t){this.container.addEventListener("click",e=>{const o=e.target.closest(".btn-remove");if(o){const n=parseInt(o.getAttribute("data-id")||"0");n>0&&t(n)}})}}class K{constructor(t){const e=document.getElementById(t);if(!e)throw new Error(`Container with ID "${t}" not found`);this.container=e}render(t){if(!t||t.length===0){this.renderEmptyState();return}this.container.innerHTML="",t.forEach(e=>{const i=this.createStockCard(e);this.container.appendChild(i)}),console.log(`Renderizados ${t.length} productos en el inventario`)}renderEmptyState(){this.container.innerHTML=`
      <div style="text-align: center; padding: 40px; color: #6d7175;">
        <span class="material-symbols-outlined" style="font-size: 48px; margin-bottom: 16px; display: block;">
          inventory_2
        </span>
        <h3 style="margin-bottom: 8px;">No hay productos en el inventario</h3>
        <p>Haz clic en "Añadir producto" para comenzar a gestionar tu stock.</p>
      </div>
    `}createStockCard(t){const e=document.createElement("article");return e.className="stock-product-card",e.setAttribute("data-product-id",t.id.toString()),e.innerHTML=`
      <figure class="stock-product-card--image">
          <img src="../assets/images/${t.img}" 
               alt="${t.nombre}"
               onerror="this.src='../assets/images/default-img.jpg'">
      </figure>
      <div class="stock-product-car--info-container">
          <div class="stock-product-car--data-container">
              <h3 class="product-card--name">${this.escapeHtml(t.nombre)}</h3>
              <p class="product-card--description">
                  <strong>ID:</strong> ${t.id}<br>
                  <strong>Dimensiones:</strong> ${this.escapeHtml(t.dimensiones)}<br>
                  <strong>Imagen:</strong> ${this.escapeHtml(t.img)}
              </p>
              <p class="product-card--price">${t.precio.toFixed(2)}€</p>
          </div>
          <div class="stock-product-card--buttons-container">
              <button class="btn-neutral btn-edit" 
                      data-id="${t.id}"
                      title="Editar ${this.escapeHtml(t.nombre)}">
                  <span class="material-symbols-outlined">edit</span> 
                  Editar producto
              </button>
              <button class="btn-delete" 
                      data-id="${t.id}"
                      title="Eliminar ${this.escapeHtml(t.nombre)}">
                  <span class="material-symbols-outlined">delete</span> 
                  Eliminar producto
              </button>
          </div>
      </div>
    `,e}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}bindEditEvent(t){this.container.addEventListener("click",e=>{const o=e.target.closest(".btn-edit");if(o){e.preventDefault(),e.stopPropagation();const n=parseInt(o.getAttribute("data-id")||"0");n>0?(console.log(`Edit button clicked for product ID: ${n}`),t(n)):console.error("Invalid product ID for edit action")}})}bindDeleteEvent(t){this.container.addEventListener("click",e=>{const o=e.target.closest(".btn-delete");if(o){e.preventDefault(),e.stopPropagation();const n=parseInt(o.getAttribute("data-id")||"0");n>0?(console.log(`Delete button clicked for product ID: ${n}`),t(n)):console.error("Invalid product ID for delete action")}})}bindAddProductEvent(t){var o;const e=["add-product-btn","crearProductoModal"];let i=null;for(const n of e)if(i=document.getElementById(n),i){console.log(`Found add button with ID: ${n}`);break}if(i)i.addEventListener("click",n=>{n.preventDefault(),console.log("Add product button clicked"),t()}),console.log("Add product event listener bound successfully");else{console.error("Add product button not found. Searched for IDs:",e);const n=document.querySelector(".btn-primary");n&&((o=n.textContent)!=null&&o.includes("Añadir"))&&(console.log("Using fallback button selector"),n.addEventListener("click",s=>{s.preventDefault(),t()}))}}highlightProduct(t){const e=this.container.querySelector(`[data-product-id="${t}"]`);e&&(e.style.transform="scale(1.02)",e.style.boxShadow="0 8px 25px rgba(0, 128, 96, 0.15)",e.style.transition="all 0.3s ease",setTimeout(()=>{e.style.transform="",e.style.boxShadow=""},2e3))}showLoading(){this.container.innerHTML=`
      <div style="text-align: center; padding: 40px;">
        <div style="border: 3px solid #f3f3f3; border-top: 3px solid #008060; 
                    border-radius: 50%; width: 40px; height: 40px; 
                    animation: spin 1s linear infinite; margin: 0 auto 16px;">
        </div>
        <p>Cargando productos...</p>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      </div>
    `}getProductCount(){return this.container.querySelectorAll(".stock-product-card").length}}class j{constructor(){this.items=[]}addItem(t){if(this.items.find(o=>o.id===t.id))return!1;const i={...t,cantidad:1};return this.items.push(i),!0}removeItem(t){const e=this.items.length;return this.items=this.items.filter(i=>i.id!==t),this.items.length<e}getItems(){return[...this.items]}getTotalPrice(){return this.items.reduce((t,e)=>t+e.precio*e.cantidad,0)}getItemCount(){return this.items.length}clear(){this.items=[]}setItems(t){this.items=[...t]}}class J{constructor(){this.init()}async init(){try{this.pwaService=new I,await c.initializeAuth(),this.initializeCurrentPage(),this.setupAuthAwareNavigation(),console.log("Aplicación inicializada correctamente")}catch(t){console.error("Error al inicializar la aplicación:",t)}}initializeCurrentPage(){const t=window.location.pathname;switch(!0){case(t==="/"||t.includes("index.html")):this.initializeHomePage();break;case t.includes("gestion-stock.html"):this.initializeStockPage();break;case t.includes("login.html"):this.initializeLoginPage();break;default:console.log("Página no reconocida:",t)}}async initializeHomePage(){this.checkAuthAccess();const t=new m,e=new j;this.productController=new H(t),this.cartController=new _(e,t),this.productView=new Y("productList"),this.cartView=new W("cartList","totalPriceValue"),this.productController.setView(this.productView),this.cartController.setView(this.cartView),await this.productController.initialize(),await this.cartController.initialize(),h.initializeNavigation(),console.log("Página de inicio inicializada")}async initializeStockPage(){if(!c.requireAuth())return;const t=new m;this.stockController=new U(t),this.stockView=new K("stockList"),this.stockController.setView(this.stockView),await this.stockController.initialize(),h.initializeNavigation(),console.log("Página de gestión de stock inicializada")}initializeLoginPage(){h.initializeLoginPage(),console.log("Página de login inicializada")}setupAuthAwareNavigation(){let t=c.isAuthenticated();setInterval(()=>{const e=c.isAuthenticated();e!==t&&(t=e,h.updateNavigationButtons(),!e&&window.location.pathname.includes("gestion-stock.html")&&(window.location.href="/"))},6e4),document.addEventListener("click",()=>{c.extendSession()}),document.addEventListener("keydown",()=>{c.extendSession()})}checkAuthAccess(){const t=c.isAuthenticated();console.log("Usuario autenticado:",t)}}document.addEventListener("DOMContentLoaded",()=>{new J});window.addEventListener("error",r=>{console.error("Error global capturado:",r.error)});window.addEventListener("unhandledrejection",r=>{console.error("Promise rechazada sin manejar:",r.reason)});
